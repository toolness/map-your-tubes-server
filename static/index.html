<!DOCTYPE html>
<meta charset="utf-8">
<title>Map Your Tubes</title>
<p>hi.</p>
<form method="post" action="/trace">
  Trace path to domain: <input type="text" name="domain" required>
  <button type="submit">Submit</button>
</form>
<script src="jquery.js"></script>
<script>
var currSessionId = 0;

// http://stackoverflow.com/a/10418013
function relativeWebSocket(path) {
  var loc = window.location, new_uri;
  if (loc.protocol === "https:") {
      new_uri = "wss:";
  } else {
      new_uri = "ws:";
  }
  new_uri += "//" + loc.host;
  return new WebSocket(new_uri + path);
}

var conn = relativeWebSocket('/');
conn.onopen = function() {
  console.log("OPEN YO");
  conn.send("SUP");
};
conn.onclose = function() {
  console.log("CLOSE YO");
};
conn.onerror = function() {
  console.log("ERROR YO");
};
conn.onmessage = function(e) {
  var data = JSON.parse(e.data);
  if (data.id > currSessionId) {
    $('.session-' + currSessionId).remove();
    currSessionId = data.id;
  }
  if (!$('.user-' + data.user).length) {
    $('<pre class="user-' + data.user + '"></pre>')
      .text('traceroute to ' + data.domain + ' for ' + data.user + '\n')
      .appendTo(document.body);
  }
  var log = $('.user-' + data.user);

  log.append(document.createTextNode(data.content + '\n'));

  console.log("MESSAGE YO", e.data);
};
</script>
