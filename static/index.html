<!DOCTYPE html>
<meta charset="utf-8">
<title>Map Your Tubes</title>
<pre>___  ___             __   __                 _____     _               
|  \/  |             \ \ / /                |_   _|   | |              
| .  . | __ _ _ __    \ V /___  _   _ _ __    | |_   _| |__   ___  ___ 
| |\/| |/ _` | '_ \    \ // _ \| | | | '__|   | | | | | '_ \ / _ \/ __|
| |  | | (_| | |_) |   | | (_) | |_| | |      | | |_| | |_) |  __/\__ \
\_|  |_/\__,_| .__/    \_/\___/ \__,_|_|      \_/\__,_|_.__/ \___||___/
             | |                                                       
             |_|                                                       </pre>
<form method="post" action="/trace" id="trace">
  Trace path to domain: <input type="text" name="domain" required>
  <button type="submit">Submit</button>
</form>
<script src="jquery.js"></script>
<script>
// http://stackoverflow.com/a/10418013
function relativeWebSocket(path) {
  var loc = window.location, new_uri;
  if (loc.protocol === "https:") {
      new_uri = "wss:";
  } else {
      new_uri = "ws:";
  }
  new_uri += "//" + loc.host;
  return new WebSocket(new_uri + path);
}

function formAsJSON(form) {
  // Would love to just use FormData instead but it insists on sending
  // the data as multipart, which we don't want to deal with on the
  // server-side.
  var payload = {};
  for (var i = 0; i < form.length; i++) {
    var control = form[i];
    if (control.name) payload[control.name] = control.value;
  }
  return payload;
}

var conn = relativeWebSocket('/');
conn.onmessage = function(e) {
  var data = JSON.parse(e.data);
  if (data.type == 'notification') {
    $('.notification, .log').remove();
    $('<div class="notification"></div>').text(data.text)
      .appendTo('body').hide().slideDown();
  } else {
    var logSelect = '.log.user-' + data.user;
    if (!$(logSelect).length) {
      $('<pre class="log user-' + data.user + '"></pre>')
        .text('traceroute to ' + data.domain + ' for ' + data.user + '\n')
        .appendTo(document.body);
    }
    $(logSelect).append(document.createTextNode(data.content + '\n'));
  }
};

$("#trace").submit(function(e) {
  e.preventDefault();

  var payload = formAsJSON(this);
  var req = new XMLHttpRequest();
  req.open("POST", this.action);
  req.setRequestHeader("Content-Type", "application/json");
  req.send(JSON.stringify(payload));
  this.reset();
});
</script>
